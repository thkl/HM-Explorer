{"version":3,"file":"ccu_communication.js","sources":["src/ccu/ccu_communication.js"],"sourcesContent":["const http = require('http')\nconst binrpc = require('binrpc')\nconst xmlrpc = require('homematic-xmlrpc')\nconst ipc = require('electron').ipcRenderer\n\nclass CCUCommunication {\n\t\n\n    constructor(ccuip) {\n\t   this.ccuIp = ccuip\n\t   this.server = null\n\t   this.listeningPort = 19872 // Ranomize this\n\t   this.localIP = this.getIPAddress()\n\t}\n\t\n\t\n\tsendInterfaceCommand(interfc,command,attributes,callback) {\n\t   var client\n\t   \n\t   console.log('Interface URL %s',interfc.url)\n\t   \n\t   if (interfc.url.startsWith('xmlrpc_bin')) {\n\t\t\t  client  = binrpc.createClient({ host: interfc.host, port: interfc.port, path: interfc.path})\n\t   } else {\n\t\t\t  client  = xmlrpc.createClient({ host: interfc.host, port: interfc.port, path: interfc.path})\n\t   }\n\n\n\t   \n\t   console.log(\"send %s with %s to %s:%s\",command,JSON.stringify(attributes),interfc.host,interfc.port)\t\t\t\n\n\t   \n\t   client.methodCall(command,attributes , function (error, value) {\n\t   \tif (callback) {\n\t\t   \tcallback(error,value)\n\t   \t}\n\t   })\n\t}\n\t\n\tsendRegaCommand(script,call_timeout,callback) {\n\t\tvar encoding = require(\"encoding\");\n\t\tscript = encoding.convert(script, \"binary\");\n\t\tvar that = this\n\t\tvar options = {\n\t\t\thost: this.ccuIp,\n\t\t\tport: 8181,\n\t\t\tpath: '/tclrega.exe',\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t'Content-Length': Buffer.byteLength(script)\n\t\t\t}\n\t\t}\n\t\t\n\t\t\n\t\tconsole.log('CCU at Rega Command :%s',script.toString());\n\t\n\t\tvar request = http.request(options, function(response) {\n\t\tvar data = '';\n\t\n  \t   response.setEncoding(\"binary\");\n\n\t\tresponse.on('data', function(chunk) {\n      \t  data += chunk.toString();\n      \t});\n      \n\t  \tresponse.on('end', function() {\n\t\t   var pos = data.lastIndexOf('<xml><exec>')\n\t \t   var tx = (data.substring(0, pos))\n\t \t   var vars = data.substr(pos)\n\t \t   console.log('CCU Rega Response :%s',tx)\n\t \t   \tcallback(tx,vars,null);\n\t \t   });\n\n\t\t}).on('error', function(e) {\n\t      console.error(e)\n\t      callback(null,null,e)\n\t\t});\n\n\t\trequest.on('socket', function (socket) {\n\t\t\tsocket.setTimeout(call_timeout * 1000) \n\t\t\tsocket.on('timeout', function() {\n\t\t\t\trequest.abort()\n    \t\t})\n\t\t})\n\n\n\t\trequest.write(script);\n\t\trequest.end();\n\t}\n\t\n\t\n\tgetIPAddress() {\n    \tvar interfaces = require('os').networkInterfaces();\n\t\tfor (var devName in interfaces) {\n\t\tvar iface = interfaces[devName]\n\t\tfor (var i = 0; i < iface.length; i++) {\n      \t  var alias = iface[i]\n\t  \t  if (alias.family === 'IPv4' && alias.address !== '127.0.0.1' && !alias.internal)\n          return alias.address\n\t\t}\n    \t}\n        return '0.0.0.0'\n    }\n\t\n\tkillRPCServer(interfc,callback) {\n\t\n\t\tvar myUrl = null\n\t\tvar that = this\n\t\tif (interfc.url.startsWith('xmlrpc_bin')) {\n\t\t\tmyUrl = \"xmlrpc_bin://\" + this.localIP + ':' + this.listeningPort\n\t\t} else {\n\t\t\tmyUrl = \"http://\" + this.localIP + ':' + this.listeningPort\n\t\t}\n\t\t\n\t\tthis.sendInterfaceCommand(interfc,'init',[myUrl],function(error,result){\n\t\t\tconsole.log('Result %s,Error %s',result,error)\n\t\t\tthat.server.server.close()\n\t\t\tconsole.log(\"Close Server\")\n\t\t\tcallback(result,error)\n\t\t})\n\t\t\n\t}\n\t\n\t\n\tinitRPCServer(interfc,callback) {\n\t\tvar rpc = null\n\t\tvar that = this\n\t\tvar myUrl = null\n\t\t\n\t\tif ((this.server) && (this.server.server)) {\n\t\t\tconsole.log('Closing Server')\n\t\t\tthis.server.server.close()\n\t\t}\n\t\t\n\t\tif (interfc.url.startsWith('xmlrpc_bin')) {\n\t\t\tthis.server = binrpc.createServer({\n\t\t\t\thost: that.localIP,\n\t\t\t\tport: that.listeningPort\n         \t});\n         \tmyUrl = \"xmlrpc_bin://\" + that.localIP + ':' + that.listeningPort\n         \t\n\t\t} else {\n\t\t\tthis.server = xmlrpc.createServer({\n\t\t\t\thost: that.localIP,\n\t\t\t\tport: that.listeningPort\n         \t});\n         \tmyUrl = \"http://\" + that.localIP + ':' + that.listeningPort\n\t\t}\n\t\t\n\t\t\n\t\t\n\t\tthis.server.on(\"NotFound\", function(method, params) {\n\t\t\tconsole.log(\"Method %s does not exist. - %s\",method, JSON.stringify(params));\n     \t});\n\n\t \tthis.server.on(\"system.listMethods\", function(err, params, callback) {\n\t \t\tcallback(null, [\"event\",\"system.listMethods\", \"system.multicall\"]);\n    \t});\n    \n\t\tthis.server.on(\"listDevices\", function(err, params, callback) {\n\t\t\tcallback(null,[]);\n\t\t});\n\n\n\t\tthis.server.on(\"newDevices\", function(err, params, callback) {\n\t\t\tcallback(null,[]);\n    \t});\n\n\n\t\tthis.server.on(\"event\", function(err, params, callback) {\n\t\t\tipc.send('xml_event',params)\n\t\t\tcallback(null,[]);\n\t\t});\n    \n\t\tthis.server.on(\"system.multicall\", function(err, params, callback) {\n\t\t\tparams.map(function(events) {\n\t\t\ttry {\n\t\t\tevents.map(function(event) {\n            \tif ((event[\"methodName\"] == \"event\") && (event[\"params\"] !== undefined)) {\n\t            \tipc.send('xml_event',event[\"params\"])\n\t\t\t\t}\n\t\t\t})\n\t\t\t} catch (e) {\n\t\t\t\tconsole.log(e)\n\t\t\t}\n\t\t\t})\n\t\t})\n\t\t\n\t\tthis.server.on(\"error\", function(err, params, callback) {\n\t\t  console.log(\"EVError %s\",err)\n\t\t  if ((that.server) && (that.server.server)) {\n\t\t\t  that.server.server.close()\n\t\t  }\n\t\t})\n\t\t\n\t\tthis.sendInterfaceCommand(interfc,'init',[myUrl, \"homematic_explorer\"],function(error,result){\n\t\t\tconsole.log('Result %s,Error %s',result,error)\n\t\t\tif (error) {\n\t\t\t\tif ((that.server) && (that.server.server)) {\n\t\t\t\t\tconsole.log('Closing Server')\n\t\t\t\t\tthat.server.server.close()\n\t\t  \t\t}\t\n\t\t\t}\n\t\t})\n\t\tcallback()\n\t}\n}\n\nmodule.exports = CCUCommunication;\n"],"names":[],"mappings":"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"}